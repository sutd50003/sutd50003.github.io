<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>50.003 - Express.js and Mongo DB - Elements of Software Construction 50.003</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Elements of Software Construction 50.003</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../l1_course_handout/" class="nav-link">Handout</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#50003-expressjs-and-mongo-db" class="nav-link">50.003 - Express.js and Mongo DB</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#learning-outcomes" class="nav-link">Learning Outcomes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#web-application" class="nav-link">Web Application</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="50003-expressjs-and-mongo-db">50.003 - Express.js and Mongo DB</h1>
<h2 id="learning-outcomes">Learning Outcomes</h2>
<p>By the end of this unit, you should be able to</p>
<ol>
<li>Develop a simple web restful API using node.js and express.js</li>
<li>Use MongoDB to manage a document database</li>
<li>Integrate the restful API with MongoDB as the database.</li>
<li>Articulate the design processes of a database. </li>
</ol>
<h2 id="web-application">Web Application</h2>
<p>A web application is a program that runs mainly on the server (not on the browser), which listens to requests from clients (such as browser, mobile app and etc). These requests are often conveyed using the hyper text transfer protocol (HTTP) or its secured variant (HTTPS). Given a request, the web application returns the correspondent response to the client. We can think of a web application takes a HTTP(s) request as input and returns a HTTP(s) response as result if the request is valid, returns an error response otherwise. </p>
<p>A simple web application can be defined using the builtin <code>http</code> module in Node.js.</p>
<p>Suppose we have a following Node.js script <code>simple_webapp.js</code></p>
<pre><code class="language-js">// import http from 'http' // won't work, not in a npm project
const http = require('http');

const webAppServer = http.createServer((req,res) =&gt; {
  if(req.url === &quot;/&quot;) {
    res.write(`
        &lt;html&gt;
            &lt;head&gt;&lt;title&gt;Welcome&lt;/title&gt;&lt;/head&gt;
            &lt;body&gt;Welcome to 50.003!&lt;/body&gt;
        &lt;/html&gt;`);
    res.end();
  }
  else {
    res.write(`
        &lt;html&gt;
            &lt;head&gt;&lt;title&gt;Error&lt;/title&gt;&lt;/head&gt;
            &lt;body&gt;Page not found&lt;/body&gt;
        &lt;/html&gt;`);
    res.end();
  }
})

webAppServer.listen(3000);
</code></pre>
<p>In the program, we instantiate an http server object <code>webAppServer</code> by calling the constructor method <code>http.createServer()</code>, which takes an executor function as the argument. The executor function expects a request and a response as inputs and writes output (HTML) to the reponse.
In the last statement, we start the web app server by calling <code>.listen(3000)</code>, i.e. the server is running on port 3000.</p>
<p>We can start the web app by running <code>node simple_webapp</code> without a need to step an npm project structure.
Open </p>
<pre><code class="language-url">http://127.0.0.1:3000/
</code></pre>
<p>in a browser will dipslay the welcome page.</p>
<p>Recall that from our previous lesson, Node.js executes the given JavaScript program statement by statement until there is nothing left in the call stack, then it continues with the event loop. The event loop will check for timer functions (which is absent in the above), check the micro and macro task queues, poll the I/O, and etc. Until there is nothing pending callback or I/O. One may ask how comes our simple_webapp program remains running? The answer lies in the last statement, the <code>.listen()</code> method keeps the web server in the event-loop by registering its executor with the HTTP request event. </p>
<p>One issue with the above implementation is that all the request to response mapping are defined in a single function and there is only one iteration. In real world projects, we need to decompose the web app into multiple modules and components to handle different functionalities, e.g. sigup/login, user profile, content access, payment and etc. Furthermore, there are some  common operations which are to be performed in nearly all requests, e.g. checking whether the user has already login. Lastly, the formatting of the return response, i.e. HTML code, CSS and client side JavaScripts should be modularized and built up systematically. 
With these consideration in mind, we often prefer using some web application framework to guide the development instead of building everything from scratch for productivity concern.</p>
<h3 id="expressjs">Express.js</h3>
<p>Express.js is one of the popular web application framework for Node.js.</p>
<p>To use express.js</p>
<pre><code class="language-bash">mkdir my_express_app
cd my_express_app
npm init
npm i express
</code></pre>
<p>Then we add a file <code>app.js</code> with the following content</p>
<pre><code class="language-js">const express = require('express')
const app = express()
const port = 3000

app.get('/', (req, res) =&gt; {
  res.send('Hello World!')
})

app.listen(port, () =&gt; {
  console.log(`Example app listening on port ${port}`)
})
</code></pre>
<p>At this stage, we have a web application created using express.js. It allows us to seperate the different request url path into different cases, <code>app.get()</code> handlers. </p>
<pre><code class="language-js">app.get('/login', (req, res) =&gt; {
    res.send(`Under construction!`)
})
</code></pre>
<p>To start the web server, run</p>
<pre><code class="language-bash">node app.js
</code></pre>
<h4 id="to-make-the-express-app-es6-compatible-optional">To make the express app ES6 compatible (optional)</h4>
<p>By default, Express.js does not support ES6.
To make it ES6 compatible, we </p>
<ol>
<li>add the following to <code>package.json</code> 
  <code>json
    "type" : "module",</code></li>
<li>Rename <code>bin/www</code> to <code>bin/www.js</code>. </li>
<li>Rewrite <code>const xyz = require('./some/package')</code> into <code>import xyz from './some/package'</code> in all the <code>.js</code> files.</li>
<li>Rewrite <code>modules.export = xyz</code> into <code>export default xyz</code>.</li>
<li>Enable Babel, refer </li>
</ol>
<pre><code class="language-url">https://dev.to/geekygeeky/get-started-with-es6-javascript-for-writing-nodejs-using-express-544h
</code></pre>
<p>For the rest of this unit we stick to CommonJS syntax.</p>
<h3 id="expressjs-generator">Express.js Generator</h3>
<p>In many cases, we may use the express generator to generate a proper project structure. First we recreate another project folder</p>
<pre><code class="language-bash">cd ..
mkdir my_eg_app
cd my_eg_app
npx express-generator --view=ejs
</code></pre>
<p>The <code>--view=ejs</code> flag sets <code>ejs</code> as the view template engine. Executing the above gives us a project folder with the following structure.</p>
<pre><code>.
├── app.js
├── bin
│   └── www
├── package.json
├── public
│   ├── images
│   ├── javascripts
│   └── stylesheets
│       └── style.css
├── routes
│   ├── index.js
│   └── users.js
└── views
    ├── error.ejs
    └── index.ejs
</code></pre>
<p>where <code>app.js</code> is the main entry script. <code>bin</code> stores dependency scripts such as <code>www</code>, <code>package.json</code> is the project file, <code>public</code> stores the static files to be delivered to the client, <code>route</code> contains the different sub-module routing rules, <code>views</code> store the view template sub modules.</p>
<p>Let's run <code>npm i</code> to download all the dependencies defined in <code>package.json</code>.</p>
<p>When it is done, run <code>npm start</code>, we observe the following in the command prompt</p>
<pre><code class="language-bash">&gt; my-eg-app@0.0.0 start
&gt; node ./bin/www
</code></pre>
<p>Opening <code>https://127.0.0.1:3000</code> in the browser, we should see a page with a <code>Welcome to Express</code> message.</p>
<h3 id="mvc-architecture">MVC architecture</h3>
<p>Express.js adopts Model View Controller architecture.<br />
<img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/MVC-Process.svg/500px-MVC-Process.svg.png" /></p>
<p>MVC groups packages and modules based on their roles and functionalities. </p>
<ol>
<li>Models. The model packages define the data being stored in the storage systems such as the databases, and abstract away the operations for data manipulation.</li>
<li>View. The view packages define representation and format of the requested data being returned to the client.</li>
<li>Controller. The controller packages define rules and routes of how user can request for and operate over the content and data.</li>
</ol>
<p>To illustrate, let's look at a simple example.</p>
<h3 id="an-echoer">An Echoer</h3>
<p>Let's build an echoer web app, which listens to the user's request and returns the same.</p>
<p>First we need to add a new routing rules to the controller. In the <code>routes</code> folder add a new file
named <code>echo.js</code> with the following content.</p>
<pre><code class="language-js">const express = require('express');
var router = express.Router();

/* GET echo listing. */
router.get('/:msg', function(req, res, next) {
    const msg = req.params.msg;
    res.send(`${msg}`);
});

module.exports = router;
</code></pre>
<p>In the above, we define a new router which listens to HTTP get requests with URL pattern
<code>/:msg</code> where <code>:msg</code> is the request parameter and returns a response containing the <code>msg</code> itself.</p>
<p>Back in the project root folder, we add the following to the <code>app.js</code></p>
<pre><code class="language-js">...
var indexRouter = require('./routes/index'); // generated by express generator
var usersRouter = require('./routes/users'); // generated by express generator
var echoRouter = require('./routes/echo');   // added by us 
var app = express(); // generated by express generator

// view engine setup
...
app.use('/', indexRouter); // generated by express generator
app.use('/users', usersRouter); // generated by express generator
app.use('/echo', echoRouter);   // added by us
</code></pre>
<p>This allows us to "link up" the newly defined <code>echo.js</code> router with the web app. More specifically, we would like the web app to listen to the HTTP get requests with URL prefix <code>/echo</code> and pass it over to the echo router. Note that there are already two existing routers generated by the express generator.</p>
<p>Now restart the web express app by pressing control-C in the command prompt and rerun <code>npm start</code>.</p>
<p>Open the URL <code>https://127.0.0.1:3000/echo/hello</code> will render the message <code>hello</code> in the browser. </p>
<p>Behind the scene, the following events took place.</p>
<ol>
<li>The web browser (client) sends a HTTP get request <code>https://127.0.0.1:3000/echo/hello</code> to the server, located at 127.0.0.1:3000.</li>
<li>The express.js app (server) receives the requests (actually it is managed by the controller), and finds that the URL path is <code>/echo/hello</code>, it forwards the subfix <code>/hello</code> to the <code>echoRouter</code>. </li>
<li>The <code>echoRouter</code> process the requests by extracting the <code>:msg</code>, i.e. <code>msg = "hello"</code>, and returns a response with <code>hello</code> as the content.</li>
<li>The web browser (client) receives the HTTP response with message <code>hello</code> and renders it.</li>
</ol>
<p>Note that in the above example, there is no business logic involved and there is no data retrieved / updated in the persitent storage. </p>
<p>Let's consider adding some few features to our web app.</p>
<p>Suppose we would like to keep track of the messages being processed by the echoer, we need to add a model (a database entity) to handle how the data is stored and retrieved. </p>
<h3 id="mongo-db">Mongo DB</h3>
<p>There are multiple choices of databases which affects the choice of model framework.</p>
<ul>
<li>Relational Database. Data are stored as records in tables. Data queries are performed by joining data from multiple tables.<ul>
<li>Pros: Very concise and strict design. Close resemblance of domain models, class diagram. Data update are guaranteed to be consistent immediately. Data redundancy is eliminated. Concurrency is handled by the database system.</li>
<li>Cons: Difficult to design, Difficult to be distributed. Join operations may be expensive. </li>
</ul>
</li>
<li>Document Database. Data are stored as documents. Data queries are performed by traversing between documents and references. <ul>
<li>Pros: A natural representation of human's perception of how data are stored. Easy to distribute the data into multiple servers. Queries operation could be faster.</li>
<li>Cons: Data update are not consistent immediately. It could lead to poor design with many data redundancy. Some level of concurrency is handled by the database system.</li>
</ul>
</li>
</ul>
<p>In this unit, we consider using a document database, MongoDB.</p>
<p>Let's install mongodb. Follow this guide.</p>
<pre><code class="language-url">https://www.mongodb.com/docs/manual/administration/install-community/
</code></pre>
<p>After the installation, run the following to start the mongo database server</p>
<ul>
<li>For Ubuntu (or Ubuntu subsystem user), <code>systemctl services start mongod</code></li>
<li>For Mac OS,  <code>brew services start mongodb-community</code></li>
</ul>
<h4 id="accessing-mongodb-via-mongo-shell">Accessing MongoDB via Mongo Shell</h4>
<p>To launch a mongoDB client, (which is called the mongo shell)</p>
<pre><code>mongosh
test&gt; show dbs;
admin   40.00 KiB
config  60.00 KiB
local   72.00 KiB
</code></pre>
<p>MongoDB is a database management system, it contains and manages multiple databases.</p>
<p>To change to a partcular database (if not exists, create it), we type</p>
<pre><code>test&gt; use echo;
</code></pre>
<p>A database contains multiple collections. We can think of a collection is a collection of documents. To check the list of collections in the database <code>echo</code>.</p>
<pre><code>echo&gt; show collections;
</code></pre>
<p>or </p>
<pre><code>echo&gt; db.collectionNames(); 
</code></pre>
<p>It means there is no collection in the database <code>echo</code>. A database has no collection will not be saved to the disk.</p>
<p>Let's create a collection. </p>
<pre><code>echo&gt; db.createCollection('message');
</code></pre>
<p>Now we have a database named <code>echo</code> which has a collection name <code>message</code>.
Let's insert some documents into the collection.</p>
<pre><code>echo&gt; db.message.insertOne({ 'key': 1, 'msg':'hello', 'time':new Date() });
{
  acknowledged: true,
  insertedId: ObjectId(&quot;646c7454389aceea398edc02&quot;)
}
echo&gt; db.message.insertOne({ 'key': 2, 'msg':'hello', 'time':new Date() });
{
  acknowledged: true,
  insertedId: ObjectId(&quot;646c747a389aceea398edc03&quot;)
}
echo&gt; db.message.find();
[
  {
    _id: ObjectId(&quot;646c7454389aceea398edc02&quot;),
    key: 1,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T08:07:48.172Z&quot;)
  },
  {
    _id: ObjectId(&quot;646c747a389aceea398edc03&quot;),
    key: 2,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T08:08:26.255Z&quot;)
  }
]
</code></pre>
<p>In the above example, we created two documents, with an integer <code>key</code>, a string <code>msg</code> and a date type attribute <code>time</code>.
Note that for every document being inserted, MongoDB automatically adds an extra attribute <code>_id</code> which is a unique identifier for that doucment. </p>
<p>For the full list of data type of MongoDB, refer to </p>
<pre><code class="language-url">https://www.mongodb.com/docs/mongodb-shell/reference/data-types/
</code></pre>
<p>Next we consider how to retrieve some documents based on some criteria.</p>
<pre><code>echo&gt; db.message.findOne({ 'key' : { $eq : 1 }})
{
  _id: ObjectId(&quot;646c7454389aceea398edc02&quot;),
  key: 1,
  msg: 'hello',
  time: ISODate(&quot;2023-05-23T08:07:48.172Z&quot;)
}
</code></pre>
<p>The above query returns a single document that having <code>key</code> equals to <code>1</code>.</p>
<p>We could also use <code>$lt</code> and <code>$gt</code> to define range queries.</p>
<pre><code>echo&gt; db.message.findOne({ 'key' : { $gt : 1 } })
{
  _id: ObjectId(&quot;646c747a389aceea398edc03&quot;),
  key: 2,
  msg: 'hello',
  time: ISODate(&quot;2023-05-23T08:08:26.255Z&quot;)
}
</code></pre>
<p>Note that <code>findOne</code> returns the one document, in case of a query that matches with multiple documents, we should use <code>find</code></p>
<pre><code>echo&gt; db.message.find({ 'key' : { $gt : 0 }})
[
  {
    _id: ObjectId(&quot;646c7454389aceea398edc02&quot;),
    key: 1,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T08:07:48.172Z&quot;)
  },
  {
    _id: ObjectId(&quot;646c747a389aceea398edc03&quot;),
    key: 2,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T08:08:26.255Z&quot;)
  }
]
</code></pre>
<p>To define a conjunctive query, we can either </p>
<ol>
<li>implicitly including multiple constraint in the same query
  <code>echo&gt; db.message.find( { 'key' : {$gt:0}, 'time': {$eq:new Date("2023-05-23T08:08:26.255Z")}})</code></li>
<li>explicitly using <code>$and</code> </li>
</ol>
<pre><code>echo&gt; db.message.find({ $and : [ {'key' : { $gt : 0 }}, {'time' : { $eq : new Date(&quot;2023-05-23T08:08:26.255Z&quot;)}}]})
</code></pre>
<p>Both yield</p>
<pre><code>[
  {
    _id: ObjectId(&quot;646c747a389aceea398edc03&quot;),
    key: 2,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T08:08:26.255Z&quot;)
  }
]
</code></pre>
<p>Similar to <code>$and</code> we can use <code>$or</code> to define disjunctive query.</p>
<pre><code>echo&gt; db.message.find({ $or : [ {'key' : { $gt : 0 }}, {'time' : { $eq : new Date(&quot;2023-05-23T08:08:26.255Z&quot;)}}]})
[
  {
    _id: ObjectId(&quot;646ca371f51912fe44f4c171&quot;),
    key: 1,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T11:28:49.094Z&quot;)
  },
  {
    _id: ObjectId(&quot;646ca378f51912fe44f4c172&quot;),
    key: 2,
    msg: 'hello',
    time: ISODate(&quot;2023-05-23T11:28:56.387Z&quot;)
  }
]
</code></pre>
<p>We may also query documents with nested documents.</p>
<pre><code>echo&gt; db.createCollection('user');
{ ok: 1 }
echo&gt; db.user.insertOne({ 'id':1, 'name':'bob', 'dob': { 'year': 2001, 'month':12, 'day':25 } });
{
  acknowledged: true,
  insertedId: ObjectId(&quot;6476a12efb9207a944895017&quot;)
}
echo&gt; db.user.find( { 'dob.year' : { $eq : 2001 }  }  )
[
  {
    _id: ObjectId(&quot;6476a12efb9207a944895017&quot;),
    id: 1,
    name: 'bob',
    dob: { year: 2001, month: 12, day: 25 }
  }
]
</code></pre>
<p>Note that the <code>find</code> method returns a list of documents, we may use a cursor variable to iterate through the document list. </p>
<pre><code>echo&gt; var cursor = db.message.find(); // note that var can be omitted here.
echo&gt; while (cursor.hasNext()) { printjson(cursor.next()); }
{
  _id: ObjectId(&quot;646c7454389aceea398edc02&quot;),
  key: 1,
  msg: 'hello',
  time: ISODate(&quot;2023-05-23T08:07:48.172Z&quot;)
},
{
  _id: ObjectId(&quot;646c747a389aceea398edc03&quot;),
  key: 2,
  msg: 'hello',
  time: ISODate(&quot;2023-05-23T08:08:26.255Z&quot;)
}
</code></pre>
<p>In the above, we call <code>.find()</code> to execute the query, the result list of documents is assigned to a <code>cursor</code> variable. The <code>cursor</code> in this context behaves similar to an iterator that found in Python and Java, i.e. we can use <code>.hasNext()</code> to check whether it has the next element, <code>.next()</code> to retrieve the next element incrementally. This allows us to scan through the set of results (which is potentially huge and not fitting in the RAM).</p>
<p>To delete a set of documents meeting the criteria, we use the <code>deleteMany</code> method.</p>
<pre><code>echo&gt; db.message.deleteMany({ 'key': { $eq: 2}}) 
</code></pre>
<p>For the full list of collection operations refer to </p>
<pre><code class="language-url">https://www.mongodb.com/docs/manual/crud/
</code></pre>
<p>and</p>
<pre><code class="language-url">https://www.mongodb.com/docs/manual/aggregation/
</code></pre>
<h3 id="mongodb-as-a-db-in-an-expressjs-app">MongoDB as a DB in an Express.js app</h3>
<p>Firstly, let's create a new project.</p>
<pre><code class="language-bash">mkdir my_mongo_app
cd my_mongo_app
npx express-generator --view=ejs
npm i mongodb
npm audit fix --force
</code></pre>
<p>We should have a project whose structure is similar to the previous echo app. Copy the <code>app.js</code> and <code>echo.js</code> files from the last app over into the current app.</p>
<p>Next we create a folder <code>models</code> under the project root folder. In the <code>models</code> folder, we create a file named <code>db.js</code> with the following content.</p>
<pre><code class="language-js">const MongoClient = require('mongodb').MongoClient;
// creating a user with a password to mongodb is recommended.
const connection_str = 'mongodb://localhost:27017/'; 
const client = new MongoClient(connection_str);
const dbName = 'echo'

var db = null;

try {
    db = client.db(dbName);
} catch (error) {
    console.error(&quot;database connection failed. &quot; + error);
}

async function cleanup() {
    await client.disconnect();
}

module.exports = { db, cleanup } ;
</code></pre>
<p>In the above we initialize the connection string and estabalish a mongodb client connection. In addition, we define a <code>cleanup()</code> function which will be callled when 
the web app terminates.</p>
<p>Then we modify the <code>app.js</code> by importing the <code>./models/db.js</code> module, and the <code>process</code> module.</p>
<pre><code class="language-js">const process = require('process');
var db = require('./models/db.js');
process.on('SIGINT', db.cleanup);
process.on('SIGTERM', db.cleanup);
</code></pre>
<p>We register the <code>SIGINT</code> (signal interupt) and the <code>SIGTERM</code> (signal terminate) events with the <code>cleanup()</code> function from the <code>db.js</code> module.</p>
<p>Next we create a new file in the <code>./models/</code> folder with name <code>message.js</code> with the following content.</p>
<pre><code class="language-js">const db = require('./db.js');

const collectionName = 'message'

class Message {
    constructor(msg, time) {
        this.msg = msg;
        this.time = time;
    }
}

/** return all mesages */
async function all() {
    try {
        const collection = db.echo.collection(collectionName);
        const cursor = collection.find();
        var messages = [];
        while (await cursor.hasNext()) {
            const dbobj = await cursor.next();
            messages.push(new Message(dbobj.msg, dbobj.time));
        }
        return messages;
    } catch(error) {
        console.error(&quot;database connection failed.&quot; + error);
        throw error;
    } 
}

/** insert a list of messages */
async function insertMany( messages ) {
    try {
        const collection = db.echo.collection(collectionName);
        await collection.insertMany(messages);
    } catch(error) {
        console.error(&quot;database connection failed.&quot; + error);
        throw error;
    } 
}

module.exports = { Message, all, find, insertMany }
</code></pre>
<p>In this module, we import the <code>db.js</code> module, we define a class <code>Message</code> with two attributes. 
In addition, we define a query function <code>all()</code> that retrieves all messages, and an <code>insertMany()</code> function that inserts new documents into the the collection.
Note that these functions are <code>async</code> as the underlying calls to the db are asynchronmous, i.e. producing promises.</p>
<p>Finally, we modify the <code>echo.js</code> router to save the echod message and retrieve all the old messages.</p>
<pre><code class="language-js">const model = require('../models/message.js');
router.get('/:msg', async function(req, res, next) {
    const msg = req.params.msg;
    const message = new model.Message(msg, new Date());
    await EchoModel.insertMany([message]);
    const messages = await model.all();
    res.send(`${JSON.stringify(messages)}`);
});
</code></pre>
<h3 id="cohort-exercise">Cohort Exercise</h3>
<ol>
<li>Modify the <code>echo</code> router so that it will return the most recent 3 messages?</li>
<li>Add an end point <code>/echo/delete</code> to the <code>echo</code> router to delete the oldest message.</li>
</ol>
<h3 id="object-data-mapping">Object Data Mapping</h3>
<p>In the above example, we incorporate the model layer to the web app. The models abstract away the underlying database operations in forms of function calls and 
class object instantiation. </p>
<p>Alternatively, we could use the <code>mongoose</code> library to help us to generate some of these codes. You are encouraged to check out the <code>mongoose</code> library.</p>
<pre><code class="language-url">https://mongoosejs.com/
</code></pre>
<h3 id="where-are-the-controllers">Where are the controllers?</h3>
<p>So far we have not seen any controller in this project. We will define controller when we need to model complex business logic which involves multiple models, which 
is absent in this example.</p>
<h3 id="a-briefing-on-data-modelling">A Briefing on Data Modelling</h3>
<p>In Software engineering, we often use UML model to formalize the system requirements. 
In Database design, we often use Entity Relation diagrams to formalize the data requirements of a system. This phase is also known as <em>conceptual modelling</em> in which we focus in identifying what data to store, rather than how to store the data.</p>
<p>An ER Diagram may consists of some of the following</p>
<ol>
<li>Entity set. An entity set captures a set of objects or items to be stored. It is represented as a rectangular box with the entity name inside. </li>
<li>Attribute. An attribute describe a property of an entity. An attribute is represented as an oval shape with the attribute name inside. Attribute serves as (part of) the primary key of the entity will be underlined.</li>
<li>Relationship. A relationship defines the relationship between entities. It is represented as a diamond shape with the relationship name inside. Relationships are often annotated with cardinality constraints. We will discuss it shortly.</li>
</ol>
<p>For instance</p>
<p><img alt="" src="../images/er1.png" /></p>
<p>The above ER diagram, we find that <code>Staff</code> as an entity set. Each staff in this entity set should have two attributes, <code>Sid</code> and <code>Name</code>. <code>Sid</code> is the unique identifier for an entity object in a set.</p>
<p>Let's consider another digram</p>
<p><img alt="" src="../images/er2.png" /></p>
<p>In the above ER diagram, we find another entity set <code>Dept</code>, which is identified by the <code>Code</code> attribute. There exists a relationship between <code>Staff</code> and <code>Dept</code> entity sets, i.e. <code>Work</code>. It implies that the database system should store the information of which staff is working in which department. The <code>N</code> and <code>1</code> annotating the connectors are known as the cardinality of the relationship. </p>
<ul>
<li>The <code>1</code> indicates that for each entity object in <code>Staff</code> there exists maximum 1 corresponding entity object in <code>Dept</code>. In plain English it means, a staff can work in only 1 department in maximum.  </li>
<li>The <code>N</code> denotes the fact that for each entity object in <code>Dept</code> there exists (infiniely) many corresponding entity objects in <code>Staff</code>. In plain English it means, a department may have many staff working inside.</li>
</ul>
<p>Let's consider another diagram</p>
<p><img alt="" src="../images/er3.png" /> </p>
<p>In the above ER diagram, we find an additional relationship between the <code>Staff</code> and <code>Dept</code>, i.e. <code>Manage</code> which captures the fact that the database system should capture the information of the manager of each department. </p>
<ul>
<li>The <code>1</code> near the <code>Dept</code> means that each staff can only be the manager of maximum one department.</li>
<li>The <code>1</code> next to the <code>Staff</code> means that each department has at most one manager.</li>
</ul>
<h3 id="er-to-document">ER to Document</h3>
<p>Mapping the ER diagram to Mongo Database collection is to determine how the data should be stored. This phase is also known as logical modelling (and subsequently physical modelling). </p>
<p>Let's consider the modelling the ER diagram with <code>Staff</code> and <code>Dept</code> and <code>Work</code> relationship (without the <code>Manage</code> relation).</p>
<p>There are more than one possible logical models.</p>
<ol>
<li>Approach one. Storing <code>Dept</code> as a collection, which has attributes <code>code</code> and <code>staffs</code>. <code>code</code> is a string, <code>staffs</code> is a list of objects. Each object in  <code>staffs</code> is a document with <code>sid</code> and <code>name</code> as attributes. e.g. 
  <code>json
  {
    'code' : 'HR',
    'staffs' : [  
      {
        'id' : 1,
        'name' : "aaron"
      }, 
      { 
        'id' : 2,
        'name' : "betty"
      }
    ]
  }</code></li>
<li>Approach two. Storing <code>Staff</code> as a separate collection, and the <code>staffs</code> attribute in the department document should contains only the ids of the staff.
A <code>dept</code> document
  <code>json
  {
    'code' : 'HR',
    'staffs' : [  
      {
        'id' : 1
      }, 
      { 
        'id' : 2
      }
    ]
  }</code>
 A <code>staff</code> document contains  <code>id</code>, <code>name</code> and <code>dept_code</code> attributes.
 <code>json
  {
    'id': 1,
    'name': 'aaron'
    'dept_code': 'HR'
  }</code>
Both design will work. The advantage of the first approach is that all the information are now stored in one collection, it is easier to ensure the data consistency, while the downside is that as the conceptual model becomes complex, we might have documents with too many level of nesting. Approach two avoids the deep nesting of the document structure, however, to maintain the data consistency requires additional checking and validation in the application. </li>
</ol>
<h3 id="cohort-exercises">Cohort Exercises</h3>
<p>Using MongoDB document example, can you give a logical design of the ER diagram with the <code>Staff</code> and <code>Dept</code> entities and <code>Work</code> and <code>Manage</code> relationships?</p>
<p>Can you implement a web app with the correspondent end-point (routes) handlers to support
1. add and update <code>staff</code>
1. add <code>dept</code>
1. find <code>staff</code>s by department code
1. find <code>staff</code>s by staff id</p>
<h3 id="some-special-cases-of-er-diagrams">Some special cases of ER diagrams</h3>
<p>There are some <em>difficult</em> cases of ER diagrams to be modeled in document database in general, </p>
<p>For instance a ternery relationship below
<img alt="" src="../images/er4.png" /> 
For simplicity, we omitted the attributes of the entities. In this design find that 
1. Given an article and a book, we find only one publisher
1. Given an article and a publisher, we find only one book,
1. Given a publisher and a book, there are many articles inside.</p>
<p>Another example is the self-loop relationship below</p>
<p><img alt="" src="../images/er5.png" />
1. A staff can be the Reporting Officer of many other staffs
2. A staff can be the Subordinate of only one managing staff.</p>
<p>Implementing these designs often require us to have <em>flat</em> document structures.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../javascripts/mathjax.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
